<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsive Camera App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            color: #222;
            background-color: #fff;
            margin: 0;
            padding: 0;
        }

        #video-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f0f0;
            border: 2px solid #0fdb80;
            margin: 20px auto;
            width: 90%;
            max-width: 600px;
            height: 300px;
            overflow: hidden;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #buttons {
            display: flex;
            justify-content: center;
            margin: 20px auto;
        }

        button {
            background-color: #0fdb80;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: scale(1.1);
        }

        footer {
            text-align: center;
            padding: 10px;
            background-color: #0fdb80;
            color: #fff;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>
<body>

<div id="video-container">
    <video id="video" autoplay></video>
</div>
<div id="buttons">
    <button id="start_button">Start</button>
    <button id="get_advice" style="display: none;">Get Advice</button>
</div>

<footer>
    (c) @fukuyuki
</footer>

<script>
    let videoStream;

    async function openCamera(facingMode = 'user') {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
        }

        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode } });
            const video = document.getElementById('video');
            video.srcObject = videoStream;
        } catch (error) {
            console.error('Error accessing camera:', error);
        }
    }

    function sayAdvice() {
        const video = document.getElementById('video');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(async blob => {
            const formData = new FormData();
            formData.append('image', blob, 'frame.jpg');

            try {
                const response = await fetch('/get_advice', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                const say = data.say;

                const utterance = new SpeechSynthesisUtterance(say);
                utterance.lang = 'ja-JP';
                utterance.rate = 1.5;
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('Error fetching advice:', error);
            }
        }, 'image/jpeg');
    }

    document.getElementById('start_button').addEventListener('click', () => {
        openCamera();
        const buttonsDiv = document.getElementById('buttons');
        buttonsDiv.innerHTML += '<button id="switch_camera">Switch Camera</button>';
        document.getElementById('start_button').style.display = 'none';
        document.getElementById('get_advice').style.display = 'inline-block';

        document.getElementById('switch_camera').addEventListener('click', () => {
            const currentFacingMode = videoStream.getTracks()[0].getSettings().facingMode;
            const newFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            openCamera(newFacingMode);
        });
    });

    document.getElementById('get_advice').addEventListener('click', () => {
        sayAdvice();
        setInterval(sayAdvice, 60000); // Repeat every minute
    });
</script>

</body>
</html>
